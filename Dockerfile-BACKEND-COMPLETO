# Dockerfile para Backend con Prisma y pnpm
# CORREGIDO: Soluciona el error "Command prisma not found"
# 
# INSTRUCCIONES:
# 1. Copia este archivo a tu repositorio del backend como "Dockerfile"
# 2. Ajusta las líneas marcadas con "AJUSTAR" según tu proyecto
# 3. Haz commit y push
# 4. Vuelve a intentar el deploy

# Stage 1: Base
FROM node:20-alpine AS base

# Instalar pnpm usando corepack
RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /app

# Stage 2: Dependencies - Instalar TODAS las dependencias
FROM base AS deps

# Copiar archivos de configuración
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

# IMPORTANTE: Instalar TODAS las dependencias (NO usar --prod)
# Necesitamos devDependencies porque Prisma CLI está ahí
RUN pnpm install --frozen-lockfile

# Stage 3: Builder - Generar Prisma y construir
FROM base AS builder

# Copiar TODAS las dependencias (incluyendo Prisma CLI)
COPY --from=deps /app/node_modules ./node_modules

# Copiar archivos de configuración
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

# Copiar schema de Prisma
COPY prisma ./prisma/

# Copiar código fuente
COPY . .

# Variables de entorno
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

# Generar el cliente de Prisma (ahora Prisma CLI está disponible)
RUN pnpm prisma generate

# AJUSTAR: Construir la aplicación según tu proyecto
# Descomenta y ajusta según tu script de build:
RUN pnpm build
# O si no tienes build, comenta la línea anterior

# Stage 4: Production - Solo dependencias de producción
FROM base AS production

WORKDIR /app

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

# Crear usuario no-root
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs

# Copiar package.json para instalar solo dependencias de producción
COPY package.json pnpm-lock.yaml ./

# Instalar solo dependencias de producción
RUN pnpm install --prod --frozen-lockfile

# IMPORTANTE: Copiar el cliente de Prisma generado desde builder
COPY --from=builder /app/node_modules/.prisma ./node_modules/.prisma
COPY --from=builder /app/node_modules/@prisma ./node_modules/@prisma

# Copiar el schema de Prisma
COPY --from=builder /app/prisma ./prisma

# AJUSTAR: Copiar código construido según tu estructura
# Opción 1: Si compilas TypeScript a dist/
COPY --from=builder /app/dist ./dist

# Opción 2: Si usas JavaScript directamente en src/
# COPY --from=builder /app/src ./src

# Opción 3: Si tienes otros archivos necesarios
# COPY --from=builder /app/public ./public
# COPY --from=builder /app/config ./config

# Copiar package.json
COPY --from=builder /app/package.json ./

# Cambiar propietario
RUN chown -R nextjs:nodejs /app

USER nextjs

EXPOSE 3000

ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# AJUSTAR: Comando de inicio según tu aplicación
# Opción 1: Si compilas TypeScript
CMD ["node", "dist/index.js"]

# Opción 2: Si usas JavaScript directamente
# CMD ["node", "src/index.js"]

# Opción 3: Si tienes un script start en package.json
# CMD ["pnpm", "start"]

