# Dockerfile para Backend con Prisma y pnpm
# CORREGIDO: Soluciona el error "Command prisma not found"
# 
# COPIA ESTE ARCHIVO COMO "Dockerfile" EN TU REPOSITORIO DEL BACKEND
# Repositorio: github.com/aaronJau21/api-aaronjSolutions

# Stage 1: Base
FROM node:20-alpine AS base

# Instalar pnpm usando corepack
RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /app

# Stage 2: Dependencies - Instalar TODAS las dependencias
FROM base AS deps

# Copiar archivos de configuración
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

# IMPORTANTE: Instalar TODAS las dependencias (NO usar --prod)
# Necesitamos devDependencies porque Prisma CLI está ahí
RUN pnpm install --frozen-lockfile

# Stage 3: Builder - Generar Prisma y construir
FROM base AS builder

# Copiar TODAS las dependencias (incluyendo Prisma CLI)
COPY --from=deps /app/node_modules ./node_modules

# Copiar archivos de configuración
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

# Copiar schema de Prisma
COPY prisma ./prisma/

# Copiar código fuente
COPY . .

# Variables de entorno
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

# Generar el cliente de Prisma (ahora Prisma CLI está disponible)
RUN pnpm prisma generate

# Construir la aplicación (ajusta según tu proyecto)
# Si tienes script "build" en package.json, descomenta:
RUN pnpm build

# Stage 4: Production - Solo dependencias de producción
FROM base AS production

WORKDIR /app

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

# Crear usuario no-root
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs

# Copiar package.json para instalar solo dependencias de producción
COPY package.json pnpm-lock.yaml ./

# Instalar solo dependencias de producción
RUN pnpm install --prod --frozen-lockfile

# IMPORTANTE: Copiar el cliente de Prisma generado desde builder
COPY --from=builder /app/node_modules/.prisma ./node_modules/.prisma
COPY --from=builder /app/node_modules/@prisma ./node_modules/@prisma

# Copiar el schema de Prisma
COPY --from=builder /app/prisma ./prisma

# Copiar código construido (ajusta según tu estructura)
# Si compilas TypeScript a dist/:
COPY --from=builder /app/dist ./dist

# Si usas JavaScript directamente en src/, descomenta:
# COPY --from=builder /app/src ./src

# Copiar package.json
COPY --from=builder /app/package.json ./

# Cambiar propietario
RUN chown -R nextjs:nodejs /app

USER nextjs

EXPOSE 3000

ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# Comando de inicio (ajusta según tu aplicación)
# Si compilas TypeScript:
CMD ["node", "dist/index.js"]

# Si usas JavaScript directamente, descomenta:
# CMD ["node", "src/index.js"]

# Si tienes script start en package.json, descomenta:
# CMD ["pnpm", "start"]

